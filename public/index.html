<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        :root { --primary-color: #0d6efd; --accent-color: #6f42c1; --success-color: #198754; --warning-color: #fd7e14; --danger-color: #dc3545; --text-color: #212529; --light-text-color: #6c757d; --bg-color: #f8f9fa; --card-bg-color: #ffffff; --border-color: #dee2e6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; }
        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; }
        .spinner { width: 56px; height: 56px; border: 7px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        .loader-text { font-size: 1.2rem; font-weight: 500; color: var(--light-text-color); }
        @keyframes spin { to { transform: rotate(360deg); } }
        #netlify-identity-button-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .sidebar { width: 240px; background-color: var(--card-bg-color); height: 100vh; position: fixed; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar-header { background-color: var(--accent-color); color: white; padding: 1.5rem; text-align: center; }
        .sidebar-header h2 { font-size: 1.2rem; margin-bottom: 0.25rem; }
        .sidebar-header .rank { font-size: 0.9rem; opacity: 0.8; }
        .sidebar-header .points { font-size: 1.75rem; font-weight: 700; margin-top: 0.75rem; }
        .nav-link { display: flex; align-items: center; padding: 1rem 1.5rem; color: var(--light-text-color); text-decoration: none; font-weight: 500; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s ease-in-out; }
        .nav-link .material-icons { margin-right: 1.25rem; }
        .nav-link:hover { background-color: #f1f3f4; }
        .nav-link.active { background-color: #e9ecef; color: var(--primary-color); font-weight: 600; border-left-color: var(--primary-color); }
        .main-content { margin-left: 240px; padding: 2.5rem; width: calc(100% - 240px - 5rem); }
        #dashboard-container { opacity: 0; transition: opacity 0.5s; width: 100%; display: none; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { font-size: 2.25rem; font-weight: 700; margin-bottom: 2rem; }
        h2 { font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; }
        .card { background-color: var(--card-bg-color); border-radius: 8px; border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem; }
        .grid-container { display: grid; gap: 1.5rem; }
        .kpi-grid { grid-template-columns: repeat(4, 1fr); }
        .kpi-card h3 { font-size: 0.9rem; font-weight: 500; color: var(--light-text-color); margin-bottom: 0.5rem; }
        .kpi-card .value { font-size: 2.25rem; font-weight: 700; color: var(--text-color); }
        .charts-grid { grid-template-columns: repeat(3, 1fr); }
        .chart-container { position: relative; height: 280px; width: 100%; }
        .gauge-container { position: relative; height: 140px; width: 100%; margin-top: 2rem; display: flex; align-items: center; justify-content: center; }
        .gauge-text { position: absolute; top: 60%; font-size: 2.5rem; font-weight: 700; color: var(--text-color); }
        .action-grid { grid-template-columns: repeat(3, 1fr); }
        .mission, .leaderboard-row { display: flex; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid #e9ecef; }
        .mission:last-child, .leaderboard-row:last-child { border-bottom: none; }
        .leaderboard-row .rank { font-size: 1.2rem; font-weight: 600; margin-right: 1rem; width: 30px; }
        .leaderboard-row .name { flex-grow: 1; }
        .leaderboard-row .points { font-weight: 500; color: var(--primary-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        thead th { font-weight: 600; color: var(--light-text-color); font-size: 0.85rem; text-transform: uppercase; }
        .top-leader-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .leader-card { text-align: center; }
        .leader-card .rank-icon { font-size: 2.5rem; }
        .leader-card.rank-1 .rank-icon { color: var(--warning-color); }
        .leader-card.rank-2 .rank-icon { color: #adb5bd; }
        .leader-card.rank-3 .rank-icon { color: #d6843c; }
        .leader-card h3 { margin: 1rem 0 0.25rem; font-size: 1.2rem; }
        .leader-card .points-label { font-size: 1.1rem; color: var(--primary-color); font-weight: 500;}
        .progress-bar { width: 100%; height: 12px; background-color: #e9ecef; border-radius: 6px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background-color: var(--primary-color); border-radius: 6px; }
        input, textarea { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box; }
        button[type="submit"] { background-color: var(--accent-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 600; cursor: pointer; }
        button:disabled { background-color: var(--light-text-color); }
    </style>
</head>
<body>
    <div id="loader" class="loader-container"></div>
    <div id="dashboard-container">
        <div class="sidebar"></div>
        <div class="main-content"></div>
    </div>
    <div id="netlify-identity-button-container" data-netlify-identity-button></div>

    <script>
        // --- EVENT LISTENERS AND MAIN FETCH LOGIC ---
        netlifyIdentity.on('login', user => { netlifyIdentity.close(); fetchAndRenderDashboard(user); });
        netlifyIdentity.on('logout', () => { location.reload(); });

        document.addEventListener("DOMContentLoaded", () => {
            const user = netlifyIdentity.currentUser();
            const loader = document.getElementById('loader');
            if (user) {
                loader.innerHTML = `<div class="spinner"></div><div class="loader-text">Loading Your Dashboard...</div>`;
                fetchAndRenderDashboard(user);
            } else {
                loader.innerHTML = `<div class="loader-text">Please log in to view the sales dashboard.</div>`;
            }
        });

        async function fetchAndRenderDashboard(user) {
            try {
                const token = await user.jwt();
                const response = await fetch('/.netlify/functions/getData', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.details || `Server error: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.view === 'Agent') { renderAgentDashboard(data); } 
                else if (data.view === 'Manager') { renderManagerDashboard(data); } 
                else if (data.view === 'HR') { renderHRDashboard(data); } 
                else { throw new Error("Unknown dashboard view received from server."); }

                document.getElementById('loader').style.display = 'none';
                document.getElementById('dashboard-container').style.display = 'block';
                document.getElementById('dashboard-container').style.opacity = 1;
            } catch (error) {
                document.getElementById('loader').innerHTML = `<div class="loader-text" style="color:var(--danger-color);">Error: ${error.message}</div>`;
            }
        }
        
        // --- RENDER FUNCTION FOR AGENT VIEW ---
        function renderAgentDashboard(data) {
            const userPoints = data.header.points || 0;
            const sidebarHtml = `<div class="sidebar-header"><h2>${data.header.name}</h2><div class="rank">Rank: <strong>${data.header.rank || 'N/A'}</strong></div><div class="points">${userPoints.toLocaleString()} pts</div></div><nav><a class="nav-link active" onclick="showPage('overview')"><i class="material-icons">dashboard</i>Overview</a><a class="nav-link" onclick="showPage('leaderboard')"><i class="material-icons">emoji_events</i>Leaderboard</a><a class="nav-link" onclick="showPage('history')"><i class="material-icons">history</i>Activity History</a></nav>`;
            document.querySelector('.sidebar').innerHTML = sidebarHtml;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div id="page-overview" class="page active"></div>
                <div id="page-leaderboard" class="page"></div>
                <div id="page-history" class="page"></div>`;
            buildOverviewPage(data);
            buildLeaderboardPage(data);
            buildHistoryPage(data);
        }

        // --- RENDER FUNCTION FOR MANAGER VIEW ---
        function renderManagerDashboard(data) {
            document.querySelector('.sidebar').innerHTML = `<div class="sidebar-header"><h2>Manager View</h2><div class="rank">${data.header.name}</div></div>`;
            const mainContent = document.querySelector('.main-content');
            let kpiHtml = '';
            for (const [key, value] of Object.entries(data.kpis)) { const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); kpiHtml += `<div class="kpi-card"><h3>${label}</h3><div class="value">${value}</div></div>`; }
            let teamHtml = '';
            data.teamPerformance.forEach(agent => { teamHtml += `<tr><td>${agent.name}</td><td>${agent.team}</td><td>$${agent.achieved}</td><td>$${agent.quota}</td><td><div class="progress-bar"><div class="progress-bar-inner" style="width: ${agent.progress}%;"></div></div></td></tr>`; });
            let pointsLeaderboardHtml = '';
            const rankIcons = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰', '4ï¸âƒ£', '5ï¸âƒ£'];
            data.pointsLeaderboard.forEach((agent, index) => { pointsLeaderboardHtml += `<div class="leaderboard-row"><div class="rank">${rankIcons[index]}</div><div class="name">${agent.name}</div><div class="points">${(agent.points || 0).toLocaleString()} pts</div></div>`; });
            mainContent.innerHTML = `<h1>Sales Manager Dashboard</h1><div class="grid-container kpi-grid card">${kpiHtml}</div><div class="grid-container" style="grid-template-columns: 3fr 2fr;"><div class="card"><h2>Team Performance (This Month)</h2><div style="max-height: 400px; overflow-y: auto;"><table><thead><tr><th>Agent</th><th>Team</th><th>Achieved</th><th>Quota</th><th>Progress</th></tr></thead><tbody>${teamHtml}</tbody></table></div></div><div class="card"><h2>Revenue Trend (6 Months)</h2><div class="chart-container" style="height: 400px;"><canvas id="revenueTrendChart"></canvas></div></div></div><div class="grid-container" style="grid-template-columns: 2fr 1fr;"><div class="card"><h2>Team Pipeline by Stage</h2><div class="chart-container"><canvas id="managerPipelineChart"></canvas></div></div><div class="card"><h2>Top 5 by Points</h2><div>${pointsLeaderboardHtml}</div></div></div>`;
            renderManagerCharts(data.chartData);
        }

        // --- RENDER FUNCTION FOR HR VIEW ---
        function renderHRDashboard(data) {
            document.querySelector('.sidebar').innerHTML = `<div class="sidebar-header"><h2>HR View</h2><div class="rank">${data.header.name}</div></div>`;
            const mainContent = document.querySelector('.main-content');
            let personnelHtml = '';
            data.personnel.forEach(p => { personnelHtml += `<tr><td>${p.name}</td><td>${p.email}</td><td>${p.role}</td><td>${p.team}</td></tr>`; });
            mainContent.innerHTML = `<h1>HR Dashboard</h1><div class="grid-container" style="grid-template-columns: 1fr 1fr;"><div class="card"><h2>Post New Announcement</h2><form id="announcement-form"><input type="text" id="announcement-title" placeholder="Announcement Title" required><textarea id="announcement-message" rows="4" placeholder="Announcement Message" required></textarea><button type="submit">Post Announcement</button></form></div><div class="card"><h2>Personnel Directory</h2><div style="max-height: 400px; overflow-y: auto;"><table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Team</th></tr></thead><tbody>${personnelHtml}</tbody></table></div></div></div>`;
            document.getElementById('announcement-form').addEventListener('submit', handlePost);
        }
        
        async function handlePost(e) { e.preventDefault(); const btn = e.target.querySelector('button'); const title = document.getElementById('announcement-title').value; const message = document.getElementById('announcement-message').value; const user = netlifyIdentity.currentUser(); if (!user) { alert("You must be logged in to post."); return; } btn.disabled = true; btn.textContent = 'Posting...'; try { const token = await user.jwt(); const response = await fetch('/.netlify/functions/postAnnouncement', { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ title, message }) }); const result = await response.json(); if (!response.ok) { throw new Error(result.details || 'Failed to post announcement.'); } alert(result.message); location.reload(); } catch (error) { alert('An error occurred: ' + error.message); btn.disabled = false; btn.textContent = 'Post Announcement'; } }
        
        // --- HELPER FUNCTIONS FOR AGENT VIEW ---
        function buildOverviewPage(data) {
            const overviewPage = document.getElementById('page-overview');
            overviewPage.innerHTML = `<h1>Sales Dashboard</h1><div class="grid-container kpi-grid card"><div class="kpi-card"><h3>Revenue (This Month)</h3><div class="value">${data.kpis.myRevenue}</div></div><div class="kpi-card"><h3>Quota Progress</h3><div class="value">${data.kpis.quotaProgress}%</div></div><div class="kpi-card"><h3>Avg. Deal Size (Month)</h3><div class="value">${data.kpis.avgDealSize}</div></div><div class="kpi-card"><h3>Commission (This Month)</h3><div class="value">${data.kpis.myCommission}</div></div></div><div class="grid-container charts-grid"><div class="card"><h2>Quota Attainment</h2><div class="gauge-container"><canvas id="quotaGaugeChart"></canvas><div id="quotaGaugeText" class="gauge-text"></div></div></div><div class="card"><h2>Sales Pipeline</h2><div class="chart-container"><canvas id="pipelineChart"></canvas></div></div><div class="card"><h2>Revenue by Product</h2><div class="chart-container"><canvas id="productChart"></canvas></div></div></div><div class="grid-container action-grid"><div class="card"><h2>Weekly Missions</h2><div id="missions-container"></div></div><div class="card"><h2>Top 3 Agents</h2><div id="mini-leaderboard-container"></div></div><div class="card"><h2>Your Next Target</h2><div id="next-target-container"></div></div></div>`;
            renderAgentCharts(data.chartData, data.kpis.quotaProgress);
            let missionsHtml = ''; (data.tasks || []).forEach(task => { const isCompleted = task.status === 'Completed'; missionsHtml += `<div class="mission"><input type="checkbox" id="task-${task.id}" ${isCompleted ? 'checked disabled' : ''} onchange="handleTaskClick(this, '${task.id}')"><label for="task-${task.id}" style="flex-grow:1; margin-left:0.5rem;">${task.description}</label><strong style="color:var(--success-color);">+${task.points}</strong></div>`; }); document.getElementById('missions-container').innerHTML = missionsHtml || '<p>No active missions.</p>';
            let miniLeaderboardHtml = ''; const rankIconsMini = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰']; (data.leaderboard || []).slice(0, 3).forEach((agent, index) => { miniLeaderboardHtml += `<div class="leaderboard-row"><div class="rank">${rankIconsMini[index]}</div><div class="name">${agent.name}</div><div class="points">${(agent.points || 0).toLocaleString()} pts</div></div>`; }); document.getElementById('mini-leaderboard-container').innerHTML = miniLeaderboardHtml;
            let nextTargetHtml = ''; const myRank = data.header.rank; if (myRank > 1 && data.leaderboard && data.leaderboard.length >= myRank) { const agentAbove = data.leaderboard[myRank - 2]; if (agentAbove && typeof agentAbove.points === 'number' && typeof data.header.points ==='number') { const pointsNeeded = agentAbove.points - data.header.points; nextTargetHtml = `<p>You are <strong>${pointsNeeded.toLocaleString()} points</strong> behind ${agentAbove.name}!</p>`; } else { nextTargetHtml = `<p>Keep climbing the ranks!</p>`; } } else { nextTargetHtml = `<p style="font-size: 1.2rem; text-align: center;">ðŸŽ‰<br>You're #1! Great work!</p>`; } document.getElementById('next-target-container').innerHTML = nextTargetHtml;
        }
        function buildLeaderboardPage(data) { let topLeaderHtml = ''; const top3 = data.leaderboard.slice(0, 3); const rankIcons = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰']; top3.forEach((agent, index) => { topLeaderHtml += `<div class="card leader-card rank-${index + 1}"><span class="rank-icon">${rankIcons[index]}</span><h3>${agent.name}</h3><p class="points-label">${(agent.points || 0).toLocaleString()} pts</p></div>`; }); let fullLeaderboardHtml = ''; data.leaderboard.forEach(agent => { const isCurrentUser = agent.name === data.header.name; fullLeaderboardHtml += `<tr style="${isCurrentUser ? 'background-color: #e9ecef; font-weight: 600;' : ''}"><td>#${agent.rank}</td><td>${agent.name} ${isCurrentUser ? '(You)' : ''}</td><td>${agent.team}</td><td>${(agent.points || 0).toLocaleString()}</td></tr>`; }); const pageHtml = `<h1>Team Leaderboard</h1><div class="top-leader-grid">${topLeaderHtml}</div><div class="card"><h2>Full Rankings</h2><table><thead><tr><th>Rank</th><th>Agent</th><th>Team</th><th>Total Points</th></tr></thead><tbody>${fullLeaderboardHtml}</tbody></table></div>`; document.getElementById('page-leaderboard').innerHTML = pageHtml; }
        function buildHistoryPage(data) { let historyHtml = ''; data.history.forEach(item => { historyHtml += `<tr><td>${item.date}</td><td>${item.action}</td><td>${item.points}</td></tr>`; }); const pageHtml = `<h1>Your Activity History</h1><div class="card"><table><thead><tr><th>Date</th><th>Action</th><th>Points Awarded</th></tr></thead><tbody>${historyHtml}</tbody></table></div>`; document.getElementById('page-history').innerHTML = pageHtml; }
        let myCharts = {};
        function renderAgentCharts(chartData, quotaProgress) {
            Object.values(myCharts).forEach(chart => chart.destroy());
            const quotaCtx = document.getElementById('quotaGaugeChart').getContext('2d'); const progress = parseFloat(quotaProgress); document.getElementById('quotaGaugeText').textContent = progress.toFixed(1) + '%'; myCharts.quota = new Chart(quotaCtx, { type: 'doughnut', data: { datasets: [{ data: [progress, 100 - progress], backgroundColor: ['var(--primary-color)', '#e9ecef'], borderColor: 'var(--card-bg-color)', borderWidth: 4, cutout: '80%' }] }, options: { responsive: true, maintainAspectRatio: false, circumference: 180, rotation: -90, plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
            const pipelineCtx = document.getElementById('pipelineChart').getContext('2d'); myCharts.pipeline = new Chart(pipelineCtx, { type: 'bar', data: { labels: chartData.pipelineFunnel.labels, datasets: [{ label: 'Potential Revenue', data: chartData.pipelineFunnel.data, backgroundColor: ['#6f42c1', '#855eca', '#9b7ad3', '#b297dd'], borderWidth: 0 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { callback: value => '$' + (value/1000) + 'k' } } } } });
            const productCtx = document.getElementById('productChart').getContext('2d'); myCharts.product = new Chart(productCtx, { type: 'doughnut', data: { labels: chartData.revenueByProduct.labels, datasets: [{ label: 'Revenue', data: chartData.revenueByProduct.data, backgroundColor: ['#0d6efd', '#6f42c1', '#198754', '#fd7e14', '#6c757d'], borderColor: 'var(--card-bg-color)', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // THE FIX IS HERE: Corrected the single quote issue
            document.getElementById('page-' + pageName).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="showPage('${pageName}')"]`).classList.add('active');
        }
    </script>
</body>
</html>
