<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- All the CSS is the same as our last fast version -->
    <style>
        :root { /* Modern Blue & Purple Theme */
            --primary-color: #0d6efd; --accent-color: #6f42c1; --success-color: #198754;
            --warning-color: #fd7e14; --danger-color: #dc3545; --text-color: #212529;
            --light-text-color: #6c757d; --bg-color: #f8f9fa; --card-bg-color: #ffffff;
            --border-color: #dee2e6;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; }
        .loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; width: 100%; }
        .spinner { width: 56px; height: 56px; border: 7px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        .loader-text { font-size: 1.2rem; font-weight: 500; color: var(--light-text-color); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .sidebar { width: 240px; background-color: var(--card-bg-color); height: 100vh; position: fixed; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar-header { background-color: var(--accent-color); color: white; padding: 1.5rem; text-align: center; }
        .sidebar-header h2 { font-size: 1.2rem; margin-bottom: 0.25rem; }
        .sidebar-header .rank { font-size: 0.9rem; opacity: 0.8; }
        .sidebar-header .points { font-size: 1.75rem; font-weight: 700; margin-top: 0.75rem; }
        .nav-link { display: flex; align-items: center; padding: 1rem 1.5rem; color: var(--light-text-color); text-decoration: none; font-weight: 500; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s ease-in-out; }
        .nav-link .material-icons { margin-right: 1.25rem; }
        .nav-link:hover { background-color: #f1f3f4; }
        .nav-link.active { background-color: #e9ecef; color: var(--primary-color); font-weight: 600; border-left-color: var(--primary-color); }
        .main-content { margin-left: 240px; padding: 2.5rem; width: calc(100% - 240px - 5rem); }
        #dashboard-container { opacity: 0; transition: opacity 0.5s; width: 100%; display: none; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h1 { font-size: 2.25rem; font-weight: 700; margin-bottom: 2rem; }
        h2 { font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; }
        .card { background-color: var(--card-bg-color); border-radius: 8px; border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem; }
        .grid-container { display: grid; gap: 1.5rem; }
        .kpi-grid { grid-template-columns: repeat(4, 1fr); }
        .kpi-card h3 { font-size: 0.9rem; font-weight: 500; color: var(--light-text-color); margin-bottom: 0.5rem; }
        .kpi-card .value { font-size: 2.25rem; font-weight: 700; color: var(--text-color); }
        .charts-grid { grid-template-columns: repeat(3, 1fr); }
        .chart-container { position: relative; height: 280px; width: 100%; }
        .gauge-container { position: relative; height: 140px; width: 100%; margin-top: 2rem; display: flex; align-items: center; justify-content: center; }
        .gauge-text { position: absolute; top: 60%; font-size: 2.5rem; font-weight: 700; color: var(--text-color); }
        .action-grid { grid-template-columns: repeat(3, 1fr); }
        .mission, .leaderboard-row { display: flex; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid #e9ecef; }
        .mission:last-child, .leaderboard-row:last-child { border-bottom: none; }
        .leaderboard-row .rank { font-size: 1.2rem; font-weight: 600; margin-right: 1rem; width: 30px; }
        .leaderboard-row .name { flex-grow: 1; }
        .leaderboard-row .points { font-weight: 500; color: var(--primary-color); }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        thead th { font-weight: 600; color: var(--light-text-color); font-size: 0.85rem; text-transform: uppercase; }
        .top-leader-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .leader-card { text-align: center; }
        .leader-card .rank-icon { font-size: 2.5rem; }
        .leader-card.rank-1 .rank-icon { color: var(--warning-color); }
        .leader-card.rank-2 .rank-icon { color: #adb5bd; }
        .leader-card.rank-3 .rank-icon { color: #d6843c; }
        .leader-card h3 { margin: 1rem 0 0.25rem; font-size: 1.2rem; }
        .leader-card .points-label { font-size: 1.1rem; color: var(--primary-color); font-weight: 500;}
    </style>
</head>
<body>
    <div id="loader" class="loader-container">
        <div class="spinner"></div>
        <div class="loader-text">The Sales Dashboard is loading...</div>
    </div>
    <div id="dashboard-container">
        <div class="sidebar"></div>
        <div class="main-content">
            <div id="page-overview" class="page active"></div>
            <div id="page-leaderboard" class="page"></div>
            <div id="page-history" class="page"></div>
        </div>
    </div>

    <script>
        // NEW: Standard web fetch instead of google.script.run
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                // We will hardcode the agent's email for now. 
                // A real login system would be the next step.
                const userEmail = "john@evokia.com"; // <-- CHANGE THIS TO TEST DIFFERENT AGENTS

                const response = await fetch(`/.netlify/functions/getData?user=${encodeURIComponent(userEmail)}`);
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                document.getElementById('loader').innerHTML = `<div class="loader-text" style="color:var(--danger-color);">Error loading dashboard data: ${error.message}</div>`;
            }
        });

        // All the rendering functions (renderDashboard, buildOverviewPage, etc.)
        // are EXACTLY the same as our last fast version.
        
        let myCharts = {};
        function renderDashboard(data) {
            if (!data || data.error) { document.getElementById('loader').innerHTML = `<div class="loader-text" style="color:var(--danger-color);">${data ? data.error : 'Could not load dashboard data.'}</div>`; return; }
            const sidebarHtml = `<div class="sidebar-header"><h2>${data.header.name}</h2><div class="rank">Rank: <strong>${data.header.rank}</strong> of ${data.header.totalAgents}</div><div class="points">${data.header.points.toLocaleString()} pts</div></div><nav><a class="nav-link active" onclick="showPage('overview')"><i class="material-icons">dashboard</i>Overview</a><a class="nav-link" onclick="showPage('leaderboard')"><i class="material-icons">emoji_events</i>Leaderboard</a><a class="nav-link" onclick="showPage('history')"><i class="material-icons">history</i>Activity History</a></nav>`;
            document.querySelector('.sidebar').innerHTML = sidebarHtml;
            buildOverviewPage(data);
            buildLeaderboardPage(data);
            buildHistoryPage(data);
            document.getElementById('loader').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
            document.getElementById('dashboard-container').style.opacity = 1;
        }
        function buildOverviewPage(data) {
            const overviewPage = document.getElementById('page-overview');
            overviewPage.innerHTML = `<h1>Sales Dashboard</h1><div class="grid-container kpi-grid card"><div class="kpi-card"><h3>Revenue (This Month)</h3><div class="value">${data.kpis.myRevenue}</div></div><div class="kpi-card"><h3>Quota Progress</h3><div class="value">${data.kpis.quotaProgress}%</div></div><div class="kpi-card"><h3>Avg. Deal Size (Month)</h3><div class="value">${data.kpis.avgDealSize}</div></div><div class="kpi-card"><h3>Commission (This Month)</h3><div class="value">${data.kpis.myCommission}</div></div></div><div class="grid-container charts-grid"><div class="card"><h2>Quota Attainment</h2><div class="gauge-container"><canvas id="quotaGaugeChart"></canvas><div id="quotaGaugeText" class="gauge-text"></div></div></div><div class="card"><h2>Sales Pipeline</h2><div class="chart-container"><canvas id="pipelineChart"></canvas></div></div><div class="card"><h2>Revenue by Product</h2><div class="chart-container"><canvas id="productChart"></canvas></div></div></div><div class="grid-container action-grid"><div class="card"><h2>Weekly Missions</h2><div id="missions-container"></div></div><div class="card"><h2>Top 3 Agents</h2><div id="mini-leaderboard-container"></div></div><div class="card"><h2>Your Next Target</h2><div id="next-target-container"></div></div></div>`;
            renderCharts(data.chartData, data.kpis.quotaProgress);
            let missionsHtml = '';
            (data.tasks || []).forEach(task => { const isCompleted = task.status === 'Completed'; missionsHtml += `<div class="mission"><input type="checkbox" id="task-${task.id}" ${isCompleted ? 'checked disabled' : ''} onchange="handleTaskClick(this, '${task.id}')"><label for="task-${task.id}" style="flex-grow:1; margin-left:0.5rem;">${task.description}</label><strong style="color:var(--success-color);">+${task.points}</strong></div>`; });
            document.getElementById('missions-container').innerHTML = missionsHtml || '<p>No active missions.</p>';
            let miniLeaderboardHtml = '';
            const rankIconsMini = ['🥇', '🥈', '🥉'];
            (data.leaderboard || []).slice(0, 3).forEach((agent, index) => { miniLeaderboardHtml += `<div class="leaderboard-row"><div class="rank">${rankIconsMini[index]}</div><div class="name">${agent.name}</div><div class="points">${agent.points.toLocaleString()} pts</div></div>`; });
            document.getElementById('mini-leaderboard-container').innerHTML = miniLeaderboardHtml;
            let nextTargetHtml = '';
            const myRank = data.header.rank;
            if (myRank > 1 && data.leaderboard.length >= myRank) { const agentAbove = data.leaderboard[myRank - 2]; const pointsNeeded = agentAbove.points - data.header.points; const nextMission = (data.tasks || []).find(t => t.status === 'Pending'); nextTargetHtml = `<p>You are <strong>${pointsNeeded.toLocaleString()} points</strong> behind ${agentAbove.name} for the #${agentAbove.rank} spot!</p>`; if (nextMission) { nextTargetHtml += `<p style="margin-top: 1rem;"><strong>Next Action:</strong> ${nextMission.description} to earn <strong>+${nextMission.points} points</strong>.</p>`; } } else { nextTargetHtml = `<p style="font-size: 1.2rem; text-align: center; margin-top: 2rem;">🎉<br>You're #1! Keep up the great work!</p>`; }
            document.getElementById('next-target-container').innerHTML = nextTargetHtml;
        }
        function buildLeaderboardPage(data) {
            let topLeaderHtml = '';
            const top3 = data.leaderboard.slice(0, 3);
            const rankIcons = ['🥇', '🥈', '🥉'];
            top3.forEach((agent, index) => { topLeaderHtml += `<div class="card leader-card rank-${index + 1}"><span class="rank-icon">${rankIcons[index]}</span><h3>${agent.name}</h3><p class="points-label">${agent.points.toLocaleString()} pts</p></div>`; });
            let fullLeaderboardHtml = '';
            data.leaderboard.forEach(agent => { const isCurrentUser = agent.name === data.header.name; fullLeaderboardHtml += `<tr style="${isCurrentUser ? 'background-color: #e9ecef; font-weight: 600;' : ''}"><td>#${agent.rank}</td><td>${agent.name} ${isCurrentUser ? '(You)' : ''}</td><td>${agent.team}</td><td>${agent.points.toLocaleString()}</td></tr>`; });
            const pageHtml = `<h1>Team Leaderboard</h1><div class="top-leader-grid">${topLeaderHtml}</div><div class="card"><h2>Full Rankings</h2><table><thead><tr><th>Rank</th><th>Agent</th><th>Team</th><th>Total Points</th></tr></thead><tbody>${fullLeaderboardHtml}</tbody></table></div>`;
            document.getElementById('page-leaderboard').innerHTML = pageHtml;
        }
        function buildHistoryPage(data) {
            let historyHtml = '';
            data.history.forEach(item => { historyHtml += `<tr><td>${item.date}</td><td>${item.action}</td><td>${item.points}</td></tr>`; });
            const pageHtml = `<h1>Your Activity History</h1><div class="card"><table><thead><tr><th>Date</th><th>Action</th><th>Points Awarded</th></tr></thead><tbody>${historyHtml}</tbody></table></div>`;
            document.getElementById('page-history').innerHTML = pageHtml;
        }
        function handleTaskClick(checkbox, taskId) { /* This will be implemented in a future step */ alert('Task completion functionality coming soon!'); checkbox.checked = !checkbox.checked; }
        function renderCharts(chartData, quotaProgress) {
            Object.values(myCharts).forEach(chart => chart.destroy());
            const quotaCtx = document.getElementById('quotaGaugeChart').getContext('2d');
            const progress = parseFloat(quotaProgress);
            document.getElementById('quotaGaugeText').textContent = progress.toFixed(1) + '%';
            myCharts.quota = new Chart(quotaCtx, { type: 'doughnut', data: { datasets: [{ data: [progress, 100 - progress], backgroundColor: ['var(--primary-color)', '#e9ecef'], borderColor: 'var(--card-bg-color)', borderWidth: 4, cutout: '80%' }] }, options: { responsive: true, maintainAspectRatio: false, circumference: 180, rotation: -90, plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
            const pipelineCtx = document.getElementById('pipelineChart').getContext('2d');
            myCharts.pipeline = new Chart(pipelineCtx, { type: 'bar', data: { labels: chartData.pipelineFunnel.labels, datasets: [{ label: 'Potential Revenue', data: chartData.pipelineFunnel.data, backgroundColor: ['#6f42c1', '#855eca', '#9b7ad3', '#b297dd'], borderWidth: 0 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { callback: value => '$' + (value/1000) + 'k' } } } } });
            const productCtx = document.getElementById('productChart').getContext('2d');
            myCharts.product = new Chart(productCtx, { type: 'doughnut', data: { labels: chartData.revenueByProduct.labels, datasets: [{ label: 'Revenue', data: chartData.revenueByProduct.data, backgroundColor: ['#0d6efd', '#6f42c1', '#198754', '#fd7e14', '#6c757d'], borderColor: 'var(--card-bg-color)', borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
        }
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[onclick="showPage('${pageName}')"]`).classList.add('active');
        }
    </script>
</body>
</html>